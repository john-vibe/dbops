<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>dataX同步变更</title>
    <style>
        #sour_tab_cols,#sele_sour_tab_cols {
            height: 290px;
            max-height: 290px;
        }

        .modal-lg {
            width:65%;
            height:40%;
            margin-left:320px;
            margin-right:50px;
            margin-top:80px;
        }

        table{
			table-layout:fixed;
		}
        th, td {
            word-break: keep-all;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            -moz-text-overflow: ellipsis;
        }
        #doris_tab_config{
            height:200px;
        }

    </style>
</head>
<body>
    <p></p>
    <form class="form-horizontal" role="form">
           <input  id="sync_id" type="hidden"  value={{sync_id}} >
           <div class="row">
               <div class="col-md-6">
                   <div class="form-group">
                        <div>
                            <label class="col-md-2 control-label"><span id="s_sync_tag">*</span>同步标识号</label>
                        </div>
                        <div class="col-md-10">
                            <input id="sync_tag"  type="text" class="form-control" value="{{sync_tag}}">
                        </div>
                   </div>
               </div>
           </div>
           <div class="row">
               <div class="col-md-6">
                   <div class="form-group">
                        <div>
                            <label class="col-md-2 control-label"><span id="s_sync_server">*</span>同步服务器</label>
                        </div>
                        <div class="col-md-10">
                            <select class="form-control select" id="sync_server" >
                                {% for var in sync_server %}
                                   {%  if var[0]==server_id %}
                                      <option value={{var[0]}} selected = "selected">{{var[1]}}</option>
                                   {% else %}
                                       <option value={{var[0]}}>{{var[1]}}</option>
                                   {% end %}
                                {% end %}
                            </select>
                       </div>
                   </div>
               </div>
           </div>
           <div class="row">
               <div class="col-md-6">
                   <div class="form-group">
                        <div>
                            <label class="col-md-2 control-label"><span id="s_sour_db_server">*</span>源数据库实例</label>
                        </div>
                        <div class="col-md-10">
                            <select class="form-control select" id="sour_db_server" >
                                {% for var in db_server %}
                                   {%  if var[0]==sour_db_server %}
                                      <option value={{var[0]}} selected = "selected">{{var[1]}}</option>
                                   {% else %}
                                       <option value={{var[0]}}>{{var[1]}}</option>
                                   {% end %}
                                {% end %}
                            </select>
                        </div>
                   </div>
               </div>
           </div>
           <div class="row">
               <div class="col-md-6">
                   <div class="form-group">
                        <div>
                            <label class="col-md-2 control-label"><span id="s_sour_db_name">*</span>源数据库名称</label>
                        </div>
                       <div class="col-md-10">
                            <select class="form-control select" id="sour_db_name" >
                                <option value='{{sync_schema}}' selected = "selected">{{sync_schema}}</option>
                            </select>
                       </div>
                   </div>
               </div>
           </div>
           <div class="row">
               <div class="col-md-6">
                   <div class="form-group">
                        <div>
                            <label class="col-md-2 control-label"><span id="s_sour_tab_name">*</span>源数据库表名</label>
                        </div>
                       <div class="col-md-10">
                            <select class="form-control select" id="sour_tab_name" >
                                <option value='{{sync_table}}' selected = "selected">{{sync_table}}</option>
                            </select>
                       </div>
                   </div>
               </div>
               <div class="col-md-1">
                   <div class="form-group">
                        <div>
                            <button type="button" id='mdi-view-list' class="btn btn-xs waves-effect waves-light"  disabled onclick=showTabDetail()><i class="mdi mdi-view-list"></i></button>
                        </div>
                   </div>
               </div>
           </div>
           <div class="row">
                   <div class="col-md-6">
                       <div class="form-group">
                            <div>
                                <label class="col-md-2 control-label">源数据库列名</label>
                            </div>
                            <div class="col-md-10">
                                <select multiple="multiple" class="form-control" id="sour_tab_cols" >
                                </select>
                            </div>
                       </div>
                   </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group m-b-0">
                    <div class="col-sm-offset-6 col-sm-9">
                        <button type="button" id='ion-arrow-down' class="btn btn-xs waves-effect waves-light"  disabled onclick=selectAll()><i class="ion-arrow-down-a"></i></button>
                        <button type="button" id='ion-arrow-up' class="btn btn-xs waves-effect waves-light"  disabled onclick=cancelAll()><i class="ion-arrow-up-a"></i></button>
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_sele_sour_tab_cols">*</span>选择同步列名</label>
                    </div>
                     <div class="col-md-10">
                        <select multiple="multiple" class="form-control" id="sele_sour_tab_cols" >
                            <option value='{{sync_columns}}' selected = "selected">{{sync_columns}}</option>
                        </select>
                     </div>
               </div>
             </div>
           </div>
           <div class="row">
               <div class="col-md-6">
                   <div class="form-group">
                        <div>
                            <label class="col-md-2 control-label">增量同步列名</label>
                        </div>
                       <div class="col-md-10">
                            <select class="form-control select" id="sour_incr_col" >
                                <option value='{{sync_incr_col}}' selected = "selected">{{sync_incr_col}}</option>
                            </select>
                       </div>
                   </div>
               </div>
           </div>
          <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_sync_data_type">*</span>同步数据类型</label>
                    </div>
                   <div class="col-md-10">
                        <select class="form-control select" id="sync_data_type" >
                            <option value='' selected = "selected">......</option>
                            {% for var in dm_sync_data_type %}
                                {%  if var[0]==sync_type %}
                                  <option value={{var[0]}} selected = "selected">{{var[1]}}</option>
                                {% else %}
                                   <option value={{var[0]}}>{{var[1]}}</option>
                                {% end %}
                            {% end %}
                        </select>
                   </div>
               </div>
              </div>
           </div>
          <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_sync_ywlx">*</span>同步业务类型</label>
                    </div>
                    <div class="col-md-10">
                        <select class="form-control select" id="sync_ywlx" >
                            <option value='' selected = "selected">......</option>
                            {% for var in dm_sync_ywlx %}
                                {%  if var[0]==sync_ywlx %}
                                  <option value={{var[0]}} selected = "selected">{{var[1]}}</option>
                                {% else %}
                                   <option value={{var[0]}}>{{var[1]}}</option>
                                {% end %}
                            {% end %}
                        </select>
                   </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_zk_hosts">*</span>zookeeper地址</label>
                    </div>
                    <div class="col-md-10">
                        <select class="form-control select" id="zk_hosts" >
                            <option value='' selected = "selected">......</option>
                            {% for var in dm_sync_zk_host %}
                                {%  if var[0]==zk_hosts %}
                                  <option value={{var[0]}} selected = "selected">{{var[1]}}</option>
                                {% else %}
                                   <option value={{var[0]}}>{{var[1]}}</option>
                                {% end %}
                            {% end %}
                        </select>
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_hbase_thrift">*</span>hbase thrift地址</label>
                    </div>
                    <div class="col-md-10">
                        <select class="form-control select" id="hbase_thrift" >
                            <option value='' selected = "selected">......</option>
                            {% for var in dm_sync_hbase_thrift %}
                                {%  if var[0]==hbase_thrift %}
                                  <option value={{var[0]}} selected = "selected">{{var[1]}}</option>
                                {% else %}
                                   <option value={{var[0]}}>{{var[1]}}</option>
                                {% end %}
                            {% end %}
                        </select>
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_hbase_table">*</span>hbase表名</label>
                    </div>
                    <div class="col-md-10">
                        <input id="hbase_table"  type="text" class="form-control" value="{{sync_hbase_table}}" >
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_hbase_rowkey">*</span>hbase行键</label>
                    </div>
                    <div class="col-md-10">
                        <input id="hbase_rowkey"  type="text" class="form-control" value="{{sync_hbase_rowkey}}" >
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_hbase_rowkey_separator"></span>hbase行键分隔符</label>
                    </div>
                    <div class="col-md-10">
                        <input id="hbase_rowkey_separator"  type="text"  readonly class="form-control" value="{{sync_hbase_rowkey_s}}">
                    </div>
               </div>
              </div>
           </div>
          <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_es_service">*</span>ElasticSearch服务</label>
                    </div>
                    <div class="col-md-10">
                        <input id="es_service"  type="text" class="form-control" value="{{es_service}}">
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_es_index_name">*</span>ElasticSearch索引</label>
                    </div>
                    <div class="col-md-10">
                        <input id="es_index_name"  type="text" class="form-control" value="{{es_index_name}}">
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_es_type_name">*</span>ElasticSearch类型</label>
                    </div>
                    <div class="col-md-10">
                        <input id="es_type_name"  type="text" class="form-control" value="{{es_type_name}}">
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
               <div class="col-md-6">
                   <div class="form-group">
                        <div>
                            <label class="col-md-2 control-label"><span>*</span>doris实例</label>
                        </div>
                        <div class="col-md-10">
                            <select class="form-control select" id="db_doris" >
                               {% for var in db_server_doris %}
                                   {%  if var[0]==db_doris %}
                                      <option value={{var[0]}} selected = "selected">{{var[1]}}</option>
                                   {% else %}
                                       <option value={{var[0]}}>{{var[1]}}</option>
                                   {% end %}
                                {% end %}
                                <option value=''  >......</option>
                            </select>
                       </div>
                   </div>
               </div>
           </div>
           <div class="row">
               <div class="col-md-6">
                   <div class="form-group">
                        <div>
                            <label class="col-md-2 control-label"><span>*</span>doris库名</label>
                        </div>
                       <div class="col-md-10">
                            <select class="form-control select" id="doris_db_name" >
                                <option value=''  >......</option>
                                <option value='{{doris_db_name}}' selected = "selected">{{doris_db_name}}</option>
                            </select>
                       </div>
                   </div>
               </div>
           </div>
           <div class="row">
               <div class="col-md-6">
                   <div class="form-group">
                        <div>
                            <label class="col-md-2 control-label"><span>*</span>doris表名</label>
                        </div>
                        <div class="col-md-10">
                            <input id="doris_tab_name"  type="text" class="form-control"  readonly value='{{doris_tab_name}}' >
                       </div>
                   </div>
               </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span>*</span>doris批大小</label>
                    </div>
                    <div class="col-md-10">
                        <input id="doris_batch_size"  type="text" class="form-control" value='{{doris_batch_size}}' >
                    </div>
               </div>
              </div>
           </div>

          <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span>*</span>JVM配置</label>
                    </div>
                    <div class="col-md-10">
                        <input id="doris_jvm"  type="text" class="form-control"  value='{{doris_jvm}}' >
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span>*</span>表配置</label>
                    </div>
                    <div class="col-md-10">
                         <div id='doris_tab_config' class="col-md-12">{{doris_tab_config}}</div>
                    </div>
               </div>
              </div>
           </div>

           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_python3_home">*</span>python3主目录</label>
                    </div>
                    <div class="col-md-10">
                        <input id="python3_home"  type="text" class="form-control"  value="{{python3_home}}">
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_script_base">*</span>dataX脚本目录</label>
                    </div>
                    <div class="col-md-10">
                        <input id="script_base"  type="text" class="form-control"  value="{{script_path}}">
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_run_time">*</span>运行时间</label>
                    </div>
                    <div class="col-md-10">
                        <input id="run_time"  type="text" class="form-control" value="{{run_time}}">
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_task_desc">*</span>任务描述</label>
                    </div>
                    <div class="col-md-10">
                        <input id="task_desc"  type="text" class="form-control"  value="{{comments}}">
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_datax_home">*</span>dataX主目录</label>
                    </div>
                    <div class="col-md-10">
                        <input id="datax_home"  type="text" class="form-control" value="{{datax_home}}">
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_sync_time_type">*</span>同步时间类型</label>
                    </div>
                   <div class="col-md-10">
                        <select class="form-control select" id="sync_time_type" >
                            <option value='' selected = "selected">......</option>
                            {% for var in dm_sync_time_type %}
                                 {%  if var[0]==sync_time_type %}
                                   <option value={{var[0]}} selected = "selected">{{var[1]}}</option>
                                 {% else %}
                                   <option value={{var[0]}}>{{var[1]}}</option>
                                 {% end %}
                            {% end %}
                        </select>
                   </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_sync_gap">*</span>同步间隔</label>
                    </div>
                    <div class="col-md-10">
                        <input id="sync_gap"  type="text" class="form-control"  value="{{sync_gap}}" >
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_api_server">*</span>API服务器</label>
                    </div>
                    <div class="col-md-10">
                        <input id="api_server"  type="text" class="form-control" value="{{api_server}}">
                    </div>
               </div>
              </div>
           </div>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group">
                    <div>
                        <label class="col-md-2 control-label"><span id="s_status">*</span>任务状态</label>
                    </div>
                    <div class="col-md-10">
                        <select class="form-control select" id="status" name="status">
                            {% if status=='1' %}
                               <option value="1" selected = "selected">启用</option>
                               <option value="0">禁用</option>
                            {% end %}

                            {% if status=='0' %}
                                <option value='0' selected = "selected">禁用</option>
                                <option value="1">启用</option>
                            {% end %}
                        </select>
                    </div>
                </div>
              </div>
           </div>
           <br>
           <div class="row">
             <div class="col-md-6">
               <div class="form-group m-b-0">
                    <div class="col-sm-offset-6 col-sm-9">
                       <button id="save" type="button" class="btn btn-custom waves-effect waves-light btn-md">保存</button>
                       <button id="return" type="button" class="btn btn-custom waves-effect waves-light btn-md">返回</button>
                    </div>
               </div>
              </div>
           </div>
       </form>

    <div id="con-close-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">表结构:<span id='tab_stru'></span></h4>
            </div>
            <div class="modal-body">
                <p></p>
                <div class="row">
                     <div class="col-md-12">
                          <div id="div-tab">
                               <table id="example" style="white-space: nowrap;" class="table table-striped table-bordered nowrap" ></table>
                          </div>
                     </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="col-sm-offset-2 col-sm-4">
                   <button type="button" class="btn btn-custom waves-effect waves-light btn-md" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
   </div><!-- /.modal -->

    <script>

        function showTabDetail(){

            if ($('#sour_db_name').val() =='') {
                return false
            }

            $('#con-close-modal').modal({
               keyboard: false,
               backdrop:false
            });

            $('#tab_stru').text($('#sour_db_name').val())

            if ($('#sour_db_name').val()!='') {

                $.ajax({
                    url: "/get_tab_stru",
                    type: "post",
                    datatype: "json",
                    data: {
                        dbid: $('#sour_db_server').val(),
                        db_name: $('#sour_db_name').val(),
                        tab_name: $('#sour_tab_name').val()
                    },
                    success: function (dataSet) {
                        $('#example').DataTable({
                            "stripeClasses": ['cell-border', 'cell-border', 'cell-border'],
                            "dom": '<"top"<"clear">>rt<"bottom"ip<"clear">>',
                            destroy: true,
                            async: true,
                            scrollY: "300px",
                            ordering: false,
                            bAutoWidth: true,
                            scrollX: true,
                            paging: false,
                            iDisplayLength: 10,
                            data: dataSet,
                            responsive: false,
                            columns: [
                                {"title": "列名"},
                                {"title": "列描述"},
                                {"title": "列类型"},
                                {"title": "是否自增"},
                                {"title": "是否主键"},
                                {"title": "是否非空"},
                            ],
                            "language": get_languages()
                        });
                    }
                });
            }
        }

        function selectAll() {
               options=$('#sour_tab_cols option');
               if(options.length>0){
                for (var i=0;i<options.length;i++){
                      value=$(options[i]).val();
                      text =$(options[i]).text();
                      $('#sele_sour_tab_cols').append("<option value='"+value+"'>"+text+"</option>");
                }
                $('#sour_tab_cols option').remove();
               }
          }

        function cancelAll() {
               options=$('#sele_sour_tab_cols option');
               if(options.length>0){
                for (var i=0;i<options.length;i++){
                      value=$(options[i]).val();
                      text =$(options[i]).text();
                      $('#sour_tab_cols').append("<option value='"+value+"'>"+text+"</option>");
                }
                $('#sele_sour_tab_cols option').remove();
               }
          }

        function get_selec_cols(){
             var tmp='';
             var val='';
             $('#sele_sour_tab_cols option').each(function(){
               val=$(this).val();
               tmp=tmp+','+val;
             });
             return tmp.substr(1);
        }

        $('#return').on('click', function() {
           $('#main-container-div').load('/datax/change');
        });

        $("#save").click(function () {
          var editor = ace.edit("doris_tab_config")
          $.ajax({
            url: "/datax/edit/save",
            type: "post",
            datatype: "json",
            data: {
                    sync_id              : $('#sync_id').val(),
                    sync_tag             : $('#sync_tag').val(),
                    sync_server          : $('#sync_server').val(),
                    sour_db_server       : $('#sour_db_server').val(),
                    sour_db_name         : $('#sour_db_name').val(),
                    sour_tab_name        : $('#sour_tab_name').val(),
                    sour_tab_cols        : get_selec_cols(),
                    sour_incr_col        : $('#sour_incr_col').val(),
                    zk_hosts             : $('#zk_hosts').val(),
                    hbase_thrift         : $('#hbase_thrift').val(),
                    sync_hbase_table     : $('#hbase_table').val(),
                    sync_hbase_rowkey    : $('#hbase_rowkey').val(),
                    sync_hbase_rowkey_separator : $('#hbase_rowkey_separator').val(),
                    es_service           : $('#es_service').val(),
                    es_index_name        : $('#es_index_name').val(),
                    es_type_name         : $('#es_type_name').val(),
                    db_doris             : $('#db_doris').val(),
                    doris_db_name        : $('#doris_db_name').val(),
                    doris_tab_name       : $('#doris_tab_name').val(),
                    doris_batch_size     : $('#doris_batch_size').val(),
                    doris_jvm            : $('#doris_jvm').val(),
                    doris_tab_config     : editor.getValue(),
                    sync_ywlx            : $('#sync_ywlx').val(),
                    sync_data_type       : $('#sync_data_type').val(),
                    script_base          : $('#script_base').val(),
                    run_time             : $('#run_time').val(),
                    task_desc            : $('#task_desc').val(),
                    datax_home           : $('#datax_home').val(),
                    sync_time_type       : $('#sync_time_type').val(),
                    sync_gap             : $('#sync_gap').val(),
                    api_server           : $('#api_server').val(),
                    status               : $('#status').val(),
                    python3_home         : $('#python3_home').val(),
            },
            success: function (dataSet) {
                if (dataSet.code==0) {
                   swal("变更成功", "", "success")
                } else {
                   swal(dataSet.message, "", "error")
                }
            },
         });
      });

        $('#sour_db_server').change(function() {
            if ($('#sour_db_server').val()!=''){
                $.ajax({
                      url: "/get_database",
                      type: "post",
                      datatype: "json",
                      data:{
                          dbid : $('#sour_db_server').val(),
                      },
                      success: function (dataSet) {
                         $("#sour_db_name").empty();
                         $("#sele_sour_tab_cols").empty();
                         $("#sour_db_name").append("<option value=''>...</option>");
                         for(i=0;i<dataSet['message'].length;i++){
                              var val  = dataSet['message'][i];
                              var text = dataSet['message'][i];
                              $("#sour_db_name").append("<option value='"+val+"'>"+text+"</option>");
                         }
                      }
                });
            } else {
                $("#sour_db_name").empty();
                $("#sour_db_name").append("<option value=''>...</option>");
            }
        });

        $('#sour_db_name').change(function() {
            if ($('#sour_db_name').val()!=''){
                $.ajax({
                      url: "/get_tables",
                      type: "post",
                      datatype: "json",
                      data:{
                          dbid    : $('#sour_db_server').val(),
                          db_name : $('#sour_db_name').val(),
                      },
                      success: function (dataSet) {
                         console.log(dataSet)
                         $("#sour_tab_name").empty();
                         $("#sour_tab_cols").empty();
                         $("#sele_sour_tab_cols").empty();
                         $("#sour_tab_name").append("<option value=''>...</option>");
                         for(i=0;i<dataSet['message'].length;i++){
                              var val  = dataSet['message'][i];
                              var text = dataSet['message'][i];
                              $("#sour_tab_name").append("<option value='"+val+"'>"+text+"</option>");
                         }
                      }
                });
            } else {
                $("#sour_tab_name").empty();
                $("#sour_incr_col").empty();
                $("#sour_tab_name").append("<option value=''>...</option>");
                $("#sour_incr_col").append("<option value=''>...</option>");
            }
        });

        $('#sour_tab_name').change(function() {
            console.log('sour_tab_name=',$('#sour_tab_name').val());
            if ($('#sour_tab_name').val()!=''){

                $('#doris_tab_name').val($('#sour_tab_name').val())

                //更新源数据库列名
                $.ajax({
                      url: "/get_columns",
                      type: "post",
                      datatype: "json",
                      data:{
                          dbid     : $('#sour_db_server').val(),
                          db_name  : $('#sour_db_name').val(),
                          tab_name : $('#sour_tab_name').val()
                      },
                      success: function (dataSet) {
                         $("#sour_tab_cols").empty();
                         $("#sele_sour_tab_cols").empty();
                         $("#sour_incr_col").empty();
                         for(i=0;i<dataSet['message'].length;i++){
                              var val  = dataSet['message'][i][0];
                              var text = dataSet['message'][i][0]+'('+dataSet['message'][i][1]+')';
                              $("#sour_tab_cols").append("<option value='"+val+"'>"+text+"</option>");
                              var db_prefix=$('#sour_db_name').val().split('_')[1]
                              $('#hbase_table').val('hopsonone:source_'+db_prefix+'_'+$('#sour_tab_name').val());
                              $('#sync_tag').val('datax_'+$('#sour_db_name').val()+'.'+$('#sour_tab_name').val()+'_v1')
                              $('#task_desc').val('dataX同步['+db_prefix+'_'+$('#sour_tab_name').val()+'_v1]')
                         }
                         $('#ion-arrow-down').attr('disabled',false);
                         $('#ion-arrow-up').attr('disabled',false);
                         $('#mdi-view-list').attr('disabled',false);
                      }
                });

                //更新增量同步列名
                $.ajax({
                      url: "/get_incr_col",
                      type: "post",
                      datatype: "json",
                      data:{
                          dbid     : $('#sour_db_server').val(),
                          db_name  : $('#sour_db_name').val(),
                          tab_name : $('#sour_tab_name').val()
                      },
                      success: function (dataSet) {
                         $("#sour_incr_col").empty();
                         $("#sour_incr_col").append("<option value='' selected = \"selected\">"+'......'+"</option>");
                         for(i=0;i<dataSet['message'].length;i++){
                              var val  = dataSet['message'][i][0];
                              var text = dataSet['message'][i][0]+'('+dataSet['message'][i][1]+')';
                              $("#sour_incr_col").append("<option value='"+val+"'>"+text+"</option>");
                         }
                      }
                });

                //更新hbase行键
                $.ajax({
                      url: "/get_keys",
                      type: "post",
                      datatype: "json",
                      data:{
                          dbid     : $('#sour_db_server').val(),
                          db_name  : $('#sour_db_name').val(),
                          tab_name : $('#sour_tab_name').val()
                      },
                      success: function (dataSet) {
                         $("#hbase_rowkey").val(dataSet['message'])
                         $('#hbase_rowkey').attr("readonly","readonly");
                      }
                });

            } else {
                $("#sour_tab_cols").empty();
                $("#sele_sour_tab_cols").empty();
                $("#sour_incr_col").empty();
                $("#sour_tab_cols").append("<option value=''>...</option>");
                $("#sele_sour_tab_cols").append("<option value=''>...</option>");
                $("#sour_incr_col").append("<option value=''>...</option>");
                $("#hbase_rowkey").val('')
                $('#hbase_table').val('');
            }
        });

        $("#sour_tab_cols").click(function () {
               options=$('#sour_tab_cols option:selected');
               if(options.length>0){
                for (var i=0;i<options.length;i++){
                      value=$(options[i]).val();
                      text =$(options[i]).text();
                      $('#sele_sour_tab_cols').append("<option value='"+value+"'>"+text+"</option>");
                }
                $('#sour_tab_cols option:selected').remove();
               }
         });

        $("#sele_sour_tab_cols").click(function () {
               options=$('#sele_sour_tab_cols option:selected');
               if(options.length>0){
                for (var i=0;i<options.length;i++){
                      value=$(options[i]).val();
                      text =$(options[i]).text();
                      $('#sour_tab_cols').append("<option value='"+value+"'>"+text+"</option>");
                }
                $('#sele_sour_tab_cols option:selected').remove();
               }
          });

        $("#tagname").bind("input propertychange",function(){
           $("#query_btn").click();
        });

        $("#sync_ywlx").bind("input propertychange",function(){
           $("#query_btn").click();
        });

        $("#sync_type").bind("input propertychange",function(){
           $("#query_btn").click();
        });

        $('#db_doris').change(function(){
           if ($('#db_doris').val()!=''){
                $.ajax({
                      url: "/get_database",
                      type: "post",
                      datatype: "json",
                      async:false,
                      data:{
                          dbid : $('#db_doris').val(),
                      },
                      success: function (dataSet) {
                         console.log('db_doris=',dataSet)
                         $("#doris_db_name").empty();
                         $("#doris_tab_name").empty();
                         $("#doris_db_name").append("<option value=''>...</option>");
                         for(i=0;i<dataSet['message'].length;i++){
                              var val  = dataSet['message'][i];
                              var text = dataSet['message'][i];
                              $("#doris_db_name").append("<option value='"+val+"'>"+text+"</option>");
                         }
                      }
                });
            } else {
                $("#doris_db_name").empty();
                $("#doris_db_name").append("<option value=''>...</option>");
            }
        });

        // $('#doris_db_name').change(function() {
        //     $("#doris_tab_name").empty();
        //     if ($('#doris_db_name').val()!=''){
        //         $.ajax({
        //               url: "/get_tables",
        //               type: "post",
        //               datatype: "json",
        //               async:false,
        //               data:{
        //                   dbid    : $('#db_doris').val(),
        //                   db_name : $('#doris_db_name').val(),
        //               },
        //               success: function (dataSet) {
        //                  $("#doris_tab_name").append("<option value=''>...</option>");
        //                  for(i=0;i<dataSet['message'].length;i++){
        //                       var val  = dataSet['message'][i];
        //                       var text = dataSet['message'][i];
        //                       $("#doris_tab_name").append("<option value='"+val+"'>"+text+"</option>");
        //                  }
        //               }
        //         });
        //     } else {
        //         $("#doris_tab_name").append("<option value=''>......</option>");
        //     }
        // });



        function set_item_status() {
                //考虑直接隐藏这些元素，最后调试
            if  ( $('#sync_data_type').val() =='7') {
                $("#zk_hosts").empty();
                $("#hbase_thrift").empty();
                $("#hbase_table").val('');
                $('#hbase_rowkey').val('');
                $('#hbase_rowkey_separator').val('');
                $('#zk_hosts').attr("disabled",true);
                $('#hbase_thrift').attr("disabled",true);
                $('#hbase_table').attr("readonly","readonly");
                $('#hbase_rowkey').attr("readonly","readonly");
                $('#hbase_rowkey_separator').attr("readonly","readonly");

                $("#es_service").val('');
                $("#es_index_name").val('');
                $('#es_type_name').val('');
                $('#es_service').attr("disabled",true);
                $('#es_index_name').attr("disabled",true);
                $('#es_type_name').attr("disabled",true);

                $("#db_doris").attr("disabled", false);
                $("#doris_db_name").attr("disabled", false);
                $("#doris_tab_name").attr("disabled", false);
                $("#doris_batch_size").attr("disabled", false);

            } else if ( $('#sync_data_type').val() =='6') {
                $("#zk_hosts").empty();
                $("#hbase_thrift").empty();
                $("#hbase_table").val('');
                $('#hbase_rowkey').val('');
                $('#hbase_rowkey_separator').val('');
                $('#zk_hosts').attr("disabled",true);
                $('#hbase_thrift').attr("disabled",true);
                $('#hbase_table').attr("readonly","readonly");
                $('#hbase_rowkey').attr("readonly","readonly");
                $('#hbase_rowkey_separator').attr("readonly","readonly");
                $('#es_service').attr("readonly",false);
                $('#es_index_name').attr("readonly",false);
                $('#es_type_name').attr("readonly",false);
                $("#db_doris").attr("disabled", true);
                $("#doris_db_name").attr("disabled", true);
                $("#doris_tab_name").attr("disabled", true);
                $("#doris_batch_size").attr("disabled", true);
            } else {
                $('#zk_hosts').attr("disabled",false);
                $('#hbase_thrift').attr("disabled",false);
                $('#hbase_table').attr("readonly",false);
                $('#hbase_rowkey').attr("readonly",false);
                $('#hbase_rowkey_separator').attr("readonly",false);
                $('#es_service').val('');
                $('#es_service').attr("readonly",true);
                $('#es_index_name').val('');
                $('#es_index_name').attr("readonly",true);
                $('#es_type_name').val('');
                $('#es_type_name').attr("readonly",true);

                $("#db_doris").val('');
                $("#doris_db_name").val('');
                $("#doris_tab_name").val('');
                $("#doris_batch_size").val('');
                $("#db_doris").attr("disabled", true);
                $("#doris_db_name").attr("disabled", true);
                $("#doris_tab_name").attr("disabled", true);
                $("#doris_batch_size").attr("disabled", true);
            }
        }

        $('#sync_data_type').change(function() {
            set_item_status();
        });

        function set_editor(p_editor) {
              var editor = ace.edit(p_editor);
              editor.setTheme("ace/theme/xcode");
              editor.getSession().setMode("ace/mode/mysql");
              editor.getSession().setUseSoftTabs(true);
              editor.getSession().setUseWrapMode(true);
              editor.setShowPrintMargin(false);
              editor.setFontSize(14);
              editor.setOption("wrap", "free");
              ace.require("ace/ext/language_tools");
              editor.setOptions({
                 enableBasicAutocompletion: true,
                 enableSnippets: true,
                 enableLiveAutocompletion: true
              });
              editor.setHighlightActiveLine(true);
        }

        $(document).keydown(function(event){
            if (event.keyCode == 13) { //判断为Enter键
                $("#query_btn").click();
            }
         });

        $(document).ready(function() {

            //必填项标签前加红色*
            set_selected();

            set_editor('doris_tab_config')

            set_item_status()

            //加载源数据库列表
            $.ajax({
                  url: "/get_database",
                  type: "post",
                  datatype: "json",
                  async:false,
                  data:{
                      dbid : $('#sour_db_server').val(),
                  },
                  success: function (dataSet) {
                     var db=$("#sour_db_name").val()
                     $("#sour_db_name").empty();
                     $("#sour_db_name").append("<option value=''>...</option>");
                     for(i=0;i<dataSet['message'].length;i++){
                          var val  = dataSet['message'][i];
                          var text = dataSet['message'][i];
                          if (val==db){
                              $("#sour_db_name").append("<option value='"+val+"' selected = \"selected\">"+text+"</option>");
                          }else {
                              $("#sour_db_name").append("<option value='"+val+"'>"+text+"</option>");
                          }
                     }
                  }
            });

            //加载源数据库表列表
            $.ajax({
                  url: "/get_tables",
                  type: "post",
                  datatype: "json",
                  async:false,
                  data:{
                      dbid    : $('#sour_db_server').val(),
                      db_name : $('#sour_db_name').val(),
                  },
                  success: function (dataSet) {
                     var tab=$("#sour_tab_name").val()
                     $("#sour_tab_name").empty();
                     $("#sour_tab_cols").empty();
                     $("#sour_tab_name").append("<option value=''>...</option>");
                     for(i=0;i<dataSet['message'].length;i++){
                          var val  = dataSet['message'][i];
                          var text = dataSet['message'][i];
                          if (val==tab) {
                              $("#sour_tab_name").append("<option value='"+val+"' selected = \"selected\">"+text+"</option>");
                          } else {
                              $("#sour_tab_name").append("<option value='" + val + "'>" + text + "</option>");
                          }
                     }
                  }
            });

            //加载同步列名
            var sele_sour_tab_cols_arr=$('#sele_sour_tab_cols').val()[0].split(',')
            $("#sele_sour_tab_cols").empty();
            for (i=0;i<sele_sour_tab_cols_arr.length;i++){
                  value=sele_sour_tab_cols_arr[i];
                  $('#sele_sour_tab_cols').append("<option value='"+value+"'>"+value+"</option>");
            }

           //更新增量同步列名
           $.ajax({
                  url: "/get_incr_col",
                  type: "post",
                  datatype: "json",
                  async:false,
                  data:{
                      dbid     : $('#sour_db_server').val(),
                      db_name  : $('#sour_db_name').val(),
                      tab_name : $('#sour_tab_name').val()
                  },
                  success: function (dataSet) {
                         var colname=$("#sour_incr_col").val()
                         $("#sour_incr_col").empty();
                         $("#sour_incr_col").append("<option value='' selected = \"selected\">"+'......'+"</option>");
                         if (colname =='')  {
                            for(i=0;i<dataSet['message'].length;i++){
                               var val  = dataSet['message'][i][0];
                               var text = dataSet['message'][i][0]+'('+dataSet['message'][i][1]+')';
                               $("#sour_incr_col").append("<option value='"+val+"'>"+text+"</option>");
                             }
                         } else {
                              for(i=0;i<dataSet['message'].length;i++){
                                  var val  = dataSet['message'][i][0];
                                  var text = dataSet['message'][i][0]+'('+dataSet['message'][i][1]+')';
                                  if (colname==val) {
                                        $("#sour_incr_col").append("<option value='"+val+"' selected = \"selected\">"+text+"</option>");
                                  } else {
                                        $("#sour_incr_col").append("<option value='"+val+"'>"+text+"</option>");
                                  }
                              }
                         }
                  }
            });

        });


   </script>
</body>

</html>